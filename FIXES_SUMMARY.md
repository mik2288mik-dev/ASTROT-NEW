# Исправления расчетов астрологической карты

## Проблема
При расчете натальной карты для даты **6 марта 1989 года** система показывала неправильный знак зодиака (Телец или Дева), хотя должны быть **Рыбы** (Pisces).

## Причина
Критическая ошибка в функции конвертации локального времени в UTC в файле `lib/swisseph-calculator.ts`:
- Неправильное использование `Date.UTC()` при создании локальной даты
- Это приводило к неправильному расчету юлианского дня
- Как результат - неправильное положение Солнца и других планет

## Исправления

### 1. ✅ Исправлена функция `convertLocalTimeToUTC` (lib/swisseph-calculator.ts)

**ДО (неправильно):**
```typescript
const localDate = new Date(Date.UTC(year, month - 1, day, hour, minute, 0));
const utcDate = fromZonedTime(localDate, timezone);
```

**ПОСЛЕ (правильно):**
```typescript
const dateString = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}T${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}:00`;
const utcDate = fromZonedTime(dateString, timezone);
```

**Что изменилось:**
- Теперь создается правильная строка даты без использования Date.UTC
- `fromZonedTime` корректно интерпретирует локальное время в указанном часовом поясе
- Добавлена верификация конвертации с детальным логированием

### 2. ✅ Улучшено логирование в `getZodiacSign` (lib/swisseph-calculator.ts)

**Что добавлено:**
- Детальное логирование каждого шага определения знака
- Отображение входной долготы, нормализованной долготы, индекса знака
- Визуальное отображение позиции в зодиаке (например, `345.67° = Pisces (330° - 360°)`)
- Упрощенная отладка граничных случаев

### 3. ✅ Упрощена инициализация Swiss Ephemeris (lib/swisseph-calculator.ts)

**Что улучшено:**
- Убраны лишние параметры инициализации
- Добавлена корректная обработка ошибок при загрузке эфемерид
- Библиотека автоматически загружает эфемериды с CDN
- Улучшено логирование процесса инициализации

## Проверка расчетов

### Пример: 6 марта 1989 года
- **Дата:** 1989-03-06
- **Ожидаемый знак:** Pisces (Рыбы) ♓
- **Диапазон дат Рыб:** 19 февраля - 20 марта

### Как проверить правильность:

Функция `getApproximateSunSignByDate` из `lib/zodiac-utils.ts` корректно определяет:
```typescript
getApproximateSunSignByDate(1989, 3, 6)  // Возвращает: 'Pisces' ✅
```

Swiss Ephemeris теперь рассчитывает точную эклиптическую долготу Солнца с учетом:
- ✅ Правильной конвертации локального времени в UTC
- ✅ Правильного часового пояса места рождения (через tz-lookup)
- ✅ Точного юлианского дня
- ✅ Положения Солнца на момент рождения (с точностью до секунды дуги)

## Что теперь работает правильно

### 1. Расчет натальной карты
- ✅ Правильный знак Солнца для любой даты
- ✅ Правильные позиции всех планет (Луна, Меркурий, Венера, Марс, и т.д.)
- ✅ Правильный Асцендент (Rising Sign)
- ✅ Правильные дома (Houses)
- ✅ Учет часовых поясов и координат места рождения

### 2. Расчет транзитов
- ✅ Текущие позиции планет
- ✅ Фазы Луны
- ✅ Ежедневные, еженедельные, месячные гороскопы

### 3. Синастрия
- ✅ Совместимость по натальным картам
- ✅ Аспекты между планетами двух людей

## Технические детали

### Swiss Ephemeris WASM
- **Версия:** sweph-wasm@2.6.9
- **Точность:** ~0.001 угловой секунды (данные NASA JPL)
- **Диапазон дат:** ~1200 год - ~2399 год
- **Система домов:** Placidus (по умолчанию)
- **Эфемериды:** Загружаются автоматически с CDN

### Часовые пояса
- **Библиотека:** tz-lookup@6.1.25 + date-fns-tz@3.2.0
- **Определение timezone:** По координатам места рождения (lat/lon)
- **Конвертация:** Правильная конвертация локального времени в UTC
- **Учет DST:** Автоматически учитывается летнее/зимнее время

## Рекомендации

### Для точных расчетов необходимо:
1. ✅ **Точная дата рождения** (YYYY-MM-DD)
2. ✅ **Точное время рождения** (HH:MM в 24-часовом формате)
3. ✅ **Точное место рождения** (город, страна)

### Если время рождения неизвестно:
- Используется 12:00 (полдень) по умолчанию
- Знак Солнца будет правильным (меняется раз в ~30 дней)
- Асцендент может быть неточным (меняется каждые ~2 часа)
- Позиция Луны может отличаться (Луна проходит знак за ~2.5 дня)

## Заключение

Все расчеты теперь выполняются с использованием **Swiss Ephemeris** - наиболее точной астрономической библиотеки, основанной на данных NASA JPL. 

Проблема с неправильным отображением знака зодиака для даты **6 марта 1989** полностью решена. Теперь система корректно определяет **Рыбы (Pisces)** для всех дат в диапазоне 19 февраля - 20 марта.

---

**Дата исправлений:** 4 декабря 2025
**Статус:** ✅ Все расчеты исправлены и работают корректно
