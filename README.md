# Astrot - Приложение Астрологии

Астрологическое приложение, построенное на Next.js, React и TypeScript.

## Миграция с Vite на Next.js

Проект был мигрирован с Vite на Next.js для включения:
- Серверного рендеринга (SSR)
- API Routes для backend логики
- Лучшей интеграции с Railway Database
- Улучшенного сохранения данных (без fallback на localStorage)

## Начало работы

### Требования

- Node.js 18+ 
- npm или yarn
- Аккаунт Railway (для базы данных)

### Установка

1. Установите зависимости:
```bash
npm install
```

2. Настройте переменные окружения:
```bash
cp .env.example .env
```

3. Настройте файл `.env`:
- `DATABASE_URL`: Строка подключения к Railway Database
- `OPENAI_API_KEY`: (Опционально) Для AI функций
- `EPHE_PATH`: (Опционально) Путь к файлам Swiss Ephemeris
- `USE_SWE_WASM`: Установите 'true' для использования WebAssembly версии

### Разработка

Запустите сервер разработки:

```bash
npm run dev
```

Откройте [http://localhost:3000](http://localhost:3000) в браузере.

### Сборка для продакшена

```bash
npm run build
npm start
```

## Структура проекта

```
├── pages/
│   ├── api/              # API Routes
│   │   ├── users/       # Эндпоинты управления пользователями
│   │   ├── charts/       # Эндпоинты данных карт
│   │   └── astrology/   # Эндпоинты расчетов астрологии
│   ├── _app.tsx         # Next.js app wrapper
│   ├── _document.tsx    # Next.js document wrapper
│   └── index.tsx        # Главная страница
├── components/          # React компоненты
├── views/              # Компоненты страниц
├── services/           # Сервисы бизнес-логики
├── lib/                # Утилиты (БД и т.д.)
├── styles/             # Глобальные стили
└── types.ts            # Определения типов TypeScript
```

## Настройка базы данных

Приложение использует Railway Database (PostgreSQL) для сохранения данных.

### Настройка Railway Database

1. Создайте PostgreSQL базу данных на Railway
2. Railway автоматически добавит `DATABASE_URL` в переменные окружения
3. Драйвер `pg` уже установлен в проекте
4. **Миграции запускаются автоматически**:
   - После сборки через `postbuild` скрипт
   - При первом запросе к `/api/health` (если таблиц нет)
   - Вручную через `/api/migrations/run`

### Запуск миграций вручную

Если таблицы не созданы автоматически, выполните одно из действий:

**Вариант 1: Через API endpoint (рекомендуется)**
```bash
# Health check автоматически запустит миграции если нужно
curl https://your-app.railway.app/api/health

# Или напрямую запустите миграции
curl https://your-app.railway.app/api/migrations/run
```

**Вариант 2: Через Railway CLI**
```bash
railway run npm run migrate
```

**Вариант 3: Локально (для разработки)**
```bash
npm run migrate
```

### Схема базы данных

- **users**: Профили и настройки пользователей
  - id (VARCHAR PRIMARY KEY)
  - name, birth_date, birth_time, birth_place
  - is_setup, language, theme
  - is_premium, is_admin
  - three_keys (JSONB)
  - evolution (JSONB)
  - created_at, updated_at

- **charts**: Данные натальных карт пользователей
  - user_id (VARCHAR PRIMARY KEY, FOREIGN KEY)
  - chart_data (JSONB)
  - created_at, updated_at

- **migrations**: Отслеживание примененных миграций
  - id, name, applied_at

## API Routes

### Системные
- `GET /api/health` - Проверка здоровья приложения (автоматически запускает миграции если таблиц нет)
- `GET|POST /api/migrations/run` - Запуск миграций базы данных вручную

### Пользователи
- `GET /api/users/[id]` - Получить профиль пользователя
- `POST /api/users/[id]` - Создать/обновить профиль пользователя
- `GET /api/users` - Получить всех пользователей (админ)

### Карты
- `GET /api/charts/[id]` - Получить карту пользователя
- `POST /api/charts/[id]` - Сохранить карту пользователя

### Астрология
- `POST /api/astrology/natal-chart` - Рассчитать натальную карту
- `POST /api/astrology/three-keys` - Получить три ключа
- `POST /api/astrology/synastry` - Рассчитать синастрию
- `POST /api/astrology/daily-horoscope` - Получить ежедневный гороскоп
- `POST /api/astrology/weekly-horoscope` - Получить еженедельный гороскоп
- `POST /api/astrology/monthly-horoscope` - Получить ежемесячный гороскоп
- `POST /api/astrology/deep-dive` - Глубокий анализ
- `POST /api/astrology/chat` - Чат с AI

## Функции

- **Профили пользователей**: Хранение данных рождения и предпочтений пользователей
- **Натальные карты**: Расчет и отображение натальных карт
- **Три ключа**: Персонализированные астрологические инсайты
- **Синастрия**: Анализ совместимости
- **Гороскопы**: Ежедневные, еженедельные и ежемесячные гороскопы
- **Премиум подписки**: Интеграция с Telegram Stars
- **Админ панель**: Управление пользователями

## Логирование

Все API routes и сервисы включают подробное логирование:
- Логирование запросов/ответов
- Отслеживание ошибок
- Метрики производительности
- Логи операций базы данных

Проверьте консоль сервера и консоль браузера для подробных логов.

## Заметки о миграции

### Что изменилось

1. **Система сборки**: Vite → Next.js
2. **API вызовы**: Прямые внешние API → Next.js API Routes
3. **Хранение данных**: localStorage fallback → Только база данных
4. **Стилизация**: Tailwind через CDN → Tailwind через PostCSS

### Критические изменения

- Все API вызовы теперь идут через `/api/*` routes
- Больше нет localStorage fallback (данные должны сохраняться в базу данных)
- Переменные окружения используют соглашения Next.js

### Текущий статус

✅ База данных настроена и подключена к Railway  
✅ Миграции автоматически создают таблицы  
✅ API endpoints для управления пользователями и картами  
✅ Система логирования и обработки ошибок  
✅ Health check endpoint с автоматическим запуском миграций  

### Тестирование

Проект включает модульные тесты для ключевых функций:

```bash
# Запустить все тесты
npm test

# Запустить тесты в watch режиме
npm run test:watch

# Запустить тесты с покрытием
npm run test:coverage
```

**Тесты включают:**
- Валидацию входных данных (`validation.test.ts`)
- Астрологические расчеты (`swisseph-calculator.test.ts`)
- Утилиты знаков зодиака (`zodiac-utils.test.ts`)
- Интеграционные тесты API (требуют запущенного сервера)

### Улучшения кода

Проект следует лучшим практикам:
- ✅ Централизованные данные о знаках зодиака (избежание дублирования)
- ✅ Разделение бизнес-логики и презентации
- ✅ Модульные компоненты (разбиты на мелкие части)
- ✅ JSDoc комментарии для всех ключевых функций
- ✅ Понятное именование переменных
- ✅ Модульные тесты для критической логики

Подробнее см. `CODE_STRUCTURE_IMPROVEMENTS.md` и `OPTIMIZATION_SUMMARY.md`

## Лицензия

Приватный проект
