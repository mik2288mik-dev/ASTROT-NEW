# üéØ –ü–õ–ê–ù –£–õ–£–ß–®–ï–ù–ò–ô –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø

**–¶–µ–ª—å:** –°–¥–µ–ª–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–º, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–º –∏ —É–¥–æ–±–Ω—ã–º –≤ –ø–æ–¥–¥–µ—Ä–∂–∫–µ

---

## üìã –ü–†–ò–û–†–ò–¢–ò–ó–ê–¶–ò–Ø

### üî¥ –ö—Ä–∏—Ç–∏—á–Ω—ã–µ (–¥–µ–ª–∞—Ç—å –ø–µ—Ä–≤—ã–º–∏)
1. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (OWNER_ID, API keys)
2. Rate limiting
3. Backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
4. Error tracking

### üü° –í–∞–∂–Ω—ã–µ (–¥–µ–ª–∞—Ç—å –ø–æ—Å–ª–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö)
5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
6. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
7. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ë–î
8. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∫—ç—à–∞

### üü¢ –ñ–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ (–¥–µ–ª–∞—Ç—å –≤ –ø–æ—Å–ª–µ–¥–Ω—é—é –æ—á–µ—Ä–µ–¥—å)
9. UX —É–ª—É—á—à–µ–Ω–∏—è
10. –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
11. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API

---

## 1. üî¥ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨

### –ü—Ä–æ–±–ª–µ–º–∞
```typescript
// App.tsx, —Å—Ç—Ä–æ–∫–∞ 23
const OWNER_ID = 123456789;  // ‚ùå –ó–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω –≤ –∫–æ–¥–µ
```

### –†–µ—à–µ–Ω–∏–µ

#### –®–∞–≥ 1: –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
# .env.example
NEXT_PUBLIC_OWNER_ID=123456789
```

#### –®–∞–≥ 2: –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥
```typescript
// App.tsx
const OWNER_ID = process.env.NEXT_PUBLIC_OWNER_ID || '';

// –í–∞–ª–∏–¥–∞—Ü–∏—è
if (!OWNER_ID) {
  console.warn('[App] OWNER_ID not configured');
}
```

#### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ Railway
```bash
railway variables set NEXT_PUBLIC_OWNER_ID=your_telegram_id
```

#### –®–∞–≥ 4: –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å
```bash
npm run build
railway up
```

**–í—Ä–µ–º—è:** 10 –º–∏–Ω—É—Ç  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** üü¢ –õ–µ–≥–∫–æ

---

### API Keys –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

#### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
```typescript
// lib/prompts.ts
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY  // ‚úì –ü—Ä–∞–≤–∏–ª—å–Ω–æ
});
```

#### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞

1. **–†–æ—Ç–∞—Ü–∏—è –∫–ª—é—á–µ–π —Ä–∞–∑ –≤ –º–µ—Å—è—Ü**
```bash
# –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–ª—é—á –≤ OpenAI
# –û–±–Ω–æ–≤–∏—Ç—å –≤ Railway
railway variables set OPENAI_API_KEY=sk-new-key

# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å
railway up
```

2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**
```bash
# –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –≤ OpenAI dashboard
# –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ ‚Üí —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
```

**–í—Ä–µ–º—è:** 30 –º–∏–Ω—É—Ç  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** üü° –°—Ä–µ–¥–Ω–µ

---

## 2. üî¥ RATE LIMITING

### –ü—Ä–æ–±–ª–µ–º–∞
–ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤ ‚Üí –≤–æ–∑–º–æ–∂–Ω–∞ –∞—Ç–∞–∫–∞ –∏–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ OpenAI

### –†–µ—à–µ–Ω–∏–µ: Middleware —Å Redis

#### –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```bash
npm install ioredis rate-limiter-flexible
```

#### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Redis (Railway)
```bash
# –í Railway –¥–æ–±–∞–≤–∏—Ç—å Redis addon
railway add redis

# –ü–æ–ª—É—á–∏—Ç—å REDIS_URL
railway variables
```

#### –®–∞–≥ 3: –°–æ–∑–¥–∞—Ç—å middleware
```typescript
// lib/rateLimit.ts
import Redis from 'ioredis';
import { RateLimiterRedis } from 'rate-limiter-flexible';

const redis = new Redis(process.env.REDIS_URL || '');

// Free users: 10 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É
const freeLimiter = new RateLimiterRedis({
  storeClient: redis,
  keyPrefix: 'rate_limit_free',
  points: 10,
  duration: 60,
});

// Premium users: 100 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É
const premiumLimiter = new RateLimiterRedis({
  storeClient: redis,
  keyPrefix: 'rate_limit_premium',
  points: 100,
  duration: 60,
});

export async function checkRateLimit(userId: string, isPremium: boolean) {
  const limiter = isPremium ? premiumLimiter : freeLimiter;
  
  try {
    await limiter.consume(userId);
    return { ok: true };
  } catch (error) {
    return { 
      ok: false, 
      error: 'Too many requests. Please try again later.' 
    };
  }
}
```

#### –®–∞–≥ 4: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤ API routes
```typescript
// pages/api/astrology/natal-chart.ts
import { checkRateLimit } from '../../../lib/rateLimit';

export default async function handler(req, res) {
  const userId = req.body.userId;
  const isPremium = req.body.isPremium;
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ rate limit
  const rateLimitCheck = await checkRateLimit(userId, isPremium);
  if (!rateLimitCheck.ok) {
    return res.status(429).json({ 
      error: rateLimitCheck.error 
    });
  }
  
  // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
}
```

**–í—Ä–µ–º—è:** 2-3 —á–∞—Å–∞  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** üü° –°—Ä–µ–¥–Ω–µ

---

## 3. üî¥ BACKUP –ë–ê–ó–´ –î–ê–ù–ù–´–•

### –ü—Ä–æ–±–ª–µ–º–∞
–ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –±—ç–∫–∞–ø–∞ ‚Üí –ø—Ä–∏ —Å–±–æ–µ –ø–æ—Ç–µ—Ä—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ

### –†–µ—à–µ–Ω–∏–µ: Automated Backups –≤ Railway

#### –®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ Railway Dashboard
```
1. –û—Ç–∫—Ä—ã—Ç—å Railway Dashboard
2. –ü–µ—Ä–µ–π—Ç–∏ –≤ PostgreSQL service
3. Settings ‚Üí Backups
4. –í–∫–ª—é—á–∏—Ç—å "Automated Backups"
5. –í—ã–±—Ä–∞—Ç—å —á–∞—Å—Ç–æ—Ç—É: Daily (–∫–∞–∂–¥—ã–π –¥–µ–Ω—å)
6. –í—ã–±—Ä–∞—Ç—å retention: 7 days (—Ö—Ä–∞–Ω–∏—Ç—å 7 –¥–Ω–µ–π)
```

#### –®–∞–≥ 2: –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –¥–ª—è manual backup
```bash
#!/bin/bash
# scripts/backup.sh

# –ü–æ–ª—É—á–∏—Ç—å DATABASE_URL
DATABASE_URL=$(railway variables get DATABASE_URL)

# –°–æ–∑–¥–∞—Ç—å backup
BACKUP_FILE="backup_$(date +%Y%m%d_%H%M%S).sql"
pg_dump $DATABASE_URL > $BACKUP_FILE

# –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
# aws s3 cp $BACKUP_FILE s3://my-backups/

echo "Backup created: $BACKUP_FILE"
```

#### –®–∞–≥ 3: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å restore
```bash
# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ backup
psql $DATABASE_URL < backup_20251218_120000.sql
```

**–í—Ä–µ–º—è:** 1 —á–∞—Å  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** üü¢ –õ–µ–≥–∫–æ

---

## 4. üî¥ ERROR TRACKING

### –ü—Ä–æ–±–ª–µ–º–∞
–û—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ console ‚Üí –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –≤ production

### –†–µ—à–µ–Ω–∏–µ: Sentry

#### –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç –≤ Sentry
```
1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ sentry.io
2. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç (Next.js)
3. –ü–æ–ª—É—á–∏—Ç—å DSN
```

#### –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å SDK
```bash
npm install @sentry/nextjs
npx @sentry/wizard -i nextjs
```

#### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å
```typescript
// sentry.client.config.ts
import * as Sentry from "@sentry/nextjs";

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 1.0,
  
  // –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  beforeSend(event) {
    if (event.request) {
      delete event.request.cookies;
      delete event.request.headers;
    }
    return event;
  }
});
```

#### –®–∞–≥ 4: –û–±–µ—Ä–Ω—É—Ç—å API routes
```typescript
// lib/withSentry.ts
import * as Sentry from '@sentry/nextjs';

export function withSentry(handler: any) {
  return async (req: any, res: any) => {
    try {
      return await handler(req, res);
    } catch (error) {
      Sentry.captureException(error);
      res.status(500).json({ error: 'Internal server error' });
    }
  };
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
export default withSentry(async function handler(req, res) {
  // ... –∫–æ–¥
});
```

#### –®–∞–≥ 5: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã
```
1. Sentry Dashboard ‚Üí Alerts
2. –°–æ–∑–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª–æ: "Notify on any error"
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å Telegram
```

**–í—Ä–µ–º—è:** 2-3 —á–∞—Å–∞  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** üü° –°—Ä–µ–¥–Ω–µ

---

## 5. üü° –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –ü—Ä–æ–±–ª–µ–º–∞
–ú–∞–ª–æ —Ç–µ—Å—Ç–æ–≤ ‚Üí —Å–ª–æ–∂–Ω–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å, –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ —Ä–µ–≥—Ä–µ—Å—Å–∏–π

### –†–µ—à–µ–Ω–∏–µ: –†–∞—Å—à–∏—Ä–∏—Ç—å –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏

#### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
```
__tests__/
‚îú‚îÄ‚îÄ api-natal-chart.test.ts       ‚úì
‚îú‚îÄ‚îÄ swisseph-calculator.test.ts   ‚úì
‚îú‚îÄ‚îÄ validation.test.ts            ‚úì
‚îî‚îÄ‚îÄ zodiac-utils.test.ts          ‚úì
```

#### –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã

##### 1. Unit —Ç–µ—Å—Ç—ã –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤
```typescript
// __tests__/services/astrologyService.test.ts
import { calculateNatalChart } from '../../services/astrologyService';

describe('astrologyService', () => {
  describe('calculateNatalChart', () => {
    it('should calculate natal chart for valid input', async () => {
      const profile = {
        name: 'Test User',
        birthDate: '1990-01-01',
        birthTime: '12:00',
        birthPlace: 'Moscow, Russia',
        language: 'ru'
      };
      
      const chart = await calculateNatalChart(profile);
      
      expect(chart).toBeDefined();
      expect(chart.sun).toBeDefined();
      expect(chart.sun.sign).toBe('Capricorn');
    });
    
    it('should throw error for invalid place', async () => {
      const profile = {
        name: 'Test',
        birthDate: '1990-01-01',
        birthTime: '12:00',
        birthPlace: 'INVALID_PLACE_XYZ',
        language: 'ru'
      };
      
      await expect(calculateNatalChart(profile)).rejects.toThrow();
    });
  });
});
```

##### 2. Integration —Ç–µ—Å—Ç—ã –¥–ª—è API
```typescript
// __tests__/api/natal-chart.integration.test.ts
import { createMocks } from 'node-mocks-http';
import handler from '../../pages/api/astrology/natal-chart';

describe('/api/astrology/natal-chart', () => {
  it('should return 200 and chart data', async () => {
    const { req, res } = createMocks({
      method: 'POST',
      body: {
        name: 'Test',
        birthDate: '1990-01-01',
        birthTime: '12:00',
        birthPlace: 'Moscow',
        language: 'ru'
      }
    });
    
    await handler(req, res);
    
    expect(res._getStatusCode()).toBe(200);
    const data = JSON.parse(res._getData());
    expect(data.sun).toBeDefined();
  });
  
  it('should return 400 for invalid input', async () => {
    const { req, res } = createMocks({
      method: 'POST',
      body: {
        name: '',  // Invalid
        birthDate: '1990-01-01'
      }
    });
    
    await handler(req, res);
    
    expect(res._getStatusCode()).toBe(400);
  });
});
```

##### 3. E2E —Ç–µ—Å—Ç—ã —Å Playwright
```bash
npm install -D @playwright/test
npx playwright install
```

```typescript
// e2e/onboarding.spec.ts
import { test, expect } from '@playwright/test';

test('onboarding flow', async ({ page }) => {
  await page.goto('http://localhost:3000');
  
  // Fill form
  await page.fill('[name="name"]', 'Test User');
  await page.fill('[name="birthDate"]', '1990-01-01');
  await page.fill('[name="birthTime"]', '12:00');
  await page.fill('[name="birthPlace"]', 'Moscow');
  
  // Submit
  await page.click('button[type="submit"]');
  
  // Wait for chart
  await page.waitForSelector('.natal-chart', { timeout: 20000 });
  
  // Check result
  const sunSign = await page.textContent('.sun-sign');
  expect(sunSign).toBe('Capricorn');
});
```

**–í—Ä–µ–º—è:** 20-30 —á–∞—Å–æ–≤  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** üî¥ –°–ª–æ–∂–Ω–æ

---

## 6. üü° –ú–û–ù–ò–¢–û–†–ò–ù–ì

### –ü—Ä–æ–±–ª–µ–º–∞
–ù–µ—Ç –º–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ ‚Üí –Ω–µ –∑–Ω–∞–µ–º, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

### –†–µ—à–µ–Ω–∏–µ: Prometheus + Grafana

#### –®–∞–≥ 1: –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –≤ –∫–æ–¥
```bash
npm install prom-client
```

```typescript
// lib/metrics.ts
import client from 'prom-client';

// –°–æ–∑–¥–∞—Ç—å —Ä–µ–µ—Å—Ç—Ä
const register = new client.Registry();

// –ú–µ—Ç—Ä–∏–∫–∏
const httpRequestDuration = new client.Histogram({
  name: 'http_request_duration_seconds',
  help: 'Duration of HTTP requests in seconds',
  labelNames: ['method', 'route', 'status_code'],
  registers: [register]
});

const openaiRequests = new client.Counter({
  name: 'openai_requests_total',
  help: 'Total number of OpenAI API requests',
  labelNames: ['endpoint', 'status'],
  registers: [register]
});

export { register, httpRequestDuration, openaiRequests };
```

#### –®–∞–≥ 2: –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
```typescript
// pages/api/astrology/natal-chart.ts
import { httpRequestDuration } from '../../../lib/metrics';

export default async function handler(req, res) {
  const start = Date.now();
  
  try {
    // ... –∫–æ–¥
    
    const duration = (Date.now() - start) / 1000;
    httpRequestDuration
      .labels(req.method, req.url, res.statusCode.toString())
      .observe(duration);
      
  } catch (error) {
    // ... –æ–±—Ä–∞–±–æ—Ç–∫–∞
  }
}
```

#### –®–∞–≥ 3: –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏
```typescript
// pages/api/metrics.ts
import { register } from '../../lib/metrics';

export default async function handler(req, res) {
  res.setHeader('Content-Type', register.contentType);
  res.send(await register.metrics());
}
```

#### –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Grafana
```yaml
# grafana/prometheus.yml
scrape_configs:
  - job_name: 'astrot-app'
    scrape_interval: 15s
    static_configs:
      - targets: ['your-app.railway.app']
    metrics_path: /api/metrics
```

**–í—Ä–µ–º—è:** 6-8 —á–∞—Å–æ–≤  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** üü° –°—Ä–µ–¥–Ω–µ

---

## 7. üü° –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –ë–î

### –ü—Ä–æ–±–ª–µ–º–∞
–ù–µ—Ç –∏–Ω–¥–µ–∫—Å–æ–≤ –Ω–∞ —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö –ø–æ–ª—è—Ö ‚Üí –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

### –†–µ—à–µ–Ω–∏–µ: –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã

#### –ú–∏–≥—Ä–∞—Ü–∏—è
```sql
-- Migration 011: Add performance indexes
CREATE INDEX IF NOT EXISTS idx_users_is_premium 
ON users(is_premium);

CREATE INDEX IF NOT EXISTS idx_users_created_at 
ON users(created_at DESC);

CREATE INDEX IF NOT EXISTS idx_charts_updated_at 
ON charts(updated_at DESC);

CREATE INDEX IF NOT EXISTS idx_daily_horoscopes_sign_date 
ON daily_horoscopes_cache(zodiac_sign, date DESC);

-- JSONB –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è generated_content
CREATE INDEX IF NOT EXISTS idx_users_generated_content_timestamps
ON users USING gin ((generated_content->'timestamps'));

-- Analyze –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
ANALYZE users;
ANALYZE charts;
ANALYZE daily_horoscopes_cache;
```

#### –ö–æ–¥ –º–∏–≥—Ä–∞—Ü–∏–∏
```typescript
// lib/migrations.ts
async function migration011(pool: Pool): Promise<void> {
  const migrationName = '011_add_performance_indexes';
  
  if (await isMigrationApplied(pool, migrationName)) {
    log.info(`Migration ${migrationName} already applied, skipping`);
    return;
  }

  log.info(`Applying migration ${migrationName}...`);

  const queries = [
    'CREATE INDEX IF NOT EXISTS idx_users_is_premium ON users(is_premium)',
    'CREATE INDEX IF NOT EXISTS idx_users_created_at ON users(created_at DESC)',
    'CREATE INDEX IF NOT EXISTS idx_charts_updated_at ON charts(updated_at DESC)',
    'CREATE INDEX IF NOT EXISTS idx_daily_horoscopes_sign_date ON daily_horoscopes_cache(zodiac_sign, date DESC)',
    `CREATE INDEX IF NOT EXISTS idx_users_generated_content_timestamps ON users USING gin ((generated_content->'timestamps'))`,
    'ANALYZE users',
    'ANALYZE charts',
    'ANALYZE daily_horoscopes_cache'
  ];

  for (const query of queries) {
    await pool.query(query);
  }

  await markMigrationApplied(pool, migrationName);
  log.info(`Migration ${migrationName} applied successfully`);
}
```

**–í—Ä–µ–º—è:** 2-3 —á–∞—Å–∞  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** üü¢ –õ–µ–≥–∫–æ

---

## 8. üü° –†–ï–§–ê–ö–¢–û–†–ò–ù–ì –ö–≠–®–ê

### –ü—Ä–æ–±–ª–µ–º–∞
Deep Dive —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ JSONB –ø–æ–ª–µ ‚Üí –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å –æ—á–µ–Ω—å –±–æ–ª—å—à–∏–º

### –†–µ—à–µ–Ω–∏–µ: –í—ã–Ω–µ—Å—Ç–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É

#### –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞
```sql
-- Migration 012: Create deep_dive_analyses table
CREATE TABLE IF NOT EXISTS deep_dive_analyses (
  id SERIAL PRIMARY KEY,
  user_id VARCHAR(255) NOT NULL,
  topic VARCHAR(50) NOT NULL,  -- 'personality' | 'love' | 'career' | 'weakness' | 'karma'
  analysis TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  UNIQUE(user_id, topic)
);

CREATE INDEX idx_deep_dive_user_id ON deep_dive_analyses(user_id);
```

#### –û–±–Ω–æ–≤–∏—Ç—å API
```typescript
// lib/db.ts
export const db = {
  // ... existing
  
  deepDiveAnalyses: {
    async get(userId: string, topic: string) {
      const result = await pool.query(
        'SELECT analysis FROM deep_dive_analyses WHERE user_id = $1 AND topic = $2',
        [userId, topic]
      );
      return result.rows[0]?.analysis || null;
    },
    
    async set(userId: string, topic: string, analysis: string) {
      await pool.query(
        `INSERT INTO deep_dive_analyses (user_id, topic, analysis)
         VALUES ($1, $2, $3)
         ON CONFLICT (user_id, topic) DO UPDATE SET
           analysis = EXCLUDED.analysis,
           updated_at = CURRENT_TIMESTAMP`,
        [userId, topic, analysis]
      );
    }
  }
};
```

#### –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
```typescript
// scripts/migrate-deep-dive.ts
async function migrateDeepDiveData() {
  const users = await db.users.getAll();
  
  for (const user of users) {
    if (user.generated_content?.deepDiveAnalyses) {
      const deepDive = user.generated_content.deepDiveAnalyses;
      
      for (const [topic, analysis] of Object.entries(deepDive)) {
        if (analysis) {
          await db.deepDiveAnalyses.set(user.id, topic, analysis as string);
        }
      }
      
      console.log(`Migrated deep dive for user ${user.id}`);
    }
  }
  
  console.log('Migration complete!');
}
```

**–í—Ä–µ–º—è:** 10-12 —á–∞—Å–æ–≤  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** üü° –°—Ä–µ–¥–Ω–µ

---

## 9. üü¢ UX –£–õ–£–ß–®–ï–ù–ò–Ø

### Skeleton Loaders

#### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
```typescript
// Loading.tsx
{loading && <div>Loading...</div>}
```

#### –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
```typescript
// components/ui/Skeleton.tsx
export const Skeleton: React.FC<{ width?: string; height?: string }> = ({ 
  width = '100%', 
  height = '20px' 
}) => (
  <div 
    className="animate-pulse bg-gray-300 rounded"
    style={{ width, height }}
  />
);

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
<div className="space-y-3">
  <Skeleton width="60%" height="24px" />
  <Skeleton width="100%" height="16px" />
  <Skeleton width="80%" height="16px" />
</div>
```

**–í—Ä–µ–º—è:** 3-4 —á–∞—Å–∞  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** üü¢ –õ–µ–≥–∫–æ

---

### Optimistic UI Updates

#### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
```typescript
// Settings.tsx
const handleSave = async () => {
  setLoading(true);
  await saveProfile(updated);
  const reloaded = await getProfile();
  onUpdate(reloaded);
  setLoading(false);
};
```

#### –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
```typescript
const handleSave = async () => {
  // –°—Ä–∞–∑—É –æ–±–Ω–æ–≤–∏—Ç—å UI (–æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ)
  onUpdate(updated);
  
  try {
    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ–æ–Ω–µ
    await saveProfile(updated);
  } catch (error) {
    // –ü—Ä–∏ –æ—à–∏–±–∫–µ - –æ—Ç–∫–∞—Ç–∏—Ç—å
    onUpdate(oldProfile);
    alert('Failed to save');
  }
};
```

**–í—Ä–µ–º—è:** 2-3 —á–∞—Å–∞  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** üü¢ –õ–µ–≥–∫–æ

---

## 10. üü¢ –ê–ù–ê–õ–ò–¢–ò–ö–ê

### Mixpanel –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

#### –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å SDK
```bash
npm install mixpanel-browser
```

#### –®–∞–≥ 2: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
```typescript
// lib/analytics.ts
import mixpanel from 'mixpanel-browser';

mixpanel.init(process.env.NEXT_PUBLIC_MIXPANEL_TOKEN || '');

export const track = (event: string, properties?: any) => {
  mixpanel.track(event, properties);
};

export const identify = (userId: string) => {
  mixpanel.identify(userId);
};
```

#### –®–∞–≥ 3: –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è
```typescript
// App.tsx
const handleOnboardingComplete = async (profile) => {
  track('Onboarding Complete', {
    name: profile.name,
    birthPlace: profile.birthPlace,
    language: profile.language
  });
  
  // ... existing code
};

// Dashboard.tsx
useEffect(() => {
  track('Dashboard Viewed', {
    isPremium: profile.isPremium
  });
}, []);

// Paywall.tsx
const handlePurchase = async () => {
  track('Premium Purchase Initiated', {
    price: 250
  });
  
  const success = await requestPremium();
  
  if (success) {
    track('Premium Purchase Completed', {
      price: 250
    });
  } else {
    track('Premium Purchase Failed');
  }
};
```

**–í—Ä–µ–º—è:** 4-6 —á–∞—Å–æ–≤  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** üü¢ –õ–µ–≥–∫–æ

---

## üìä –ò–¢–û–ì–û–í–ê–Ø ROADMAP

### –§–∞–∑–∞ 1: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å (1-2 –Ω–µ–¥–µ–ª–∏)
- [ ] OWNER_ID –≤ env variables
- [ ] Rate limiting —Å Redis
- [ ] Automated backups
- [ ] Sentry –¥–ª—è error tracking
- [ ] –ò–Ω–¥–µ–∫—Å—ã –ë–î

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞—â–∏—â–µ–Ω–æ –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ

### –§–∞–∑–∞ 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (2-3 –Ω–µ–¥–µ–ª–∏)
- [ ] Unit —Ç–µ—Å—Ç—ã –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤ (80% coverage)
- [ ] Integration —Ç–µ—Å—Ç—ã –¥–ª—è API
- [ ] E2E —Ç–µ—Å—Ç—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ñ–ª–æ—É
- [ ] Prometheus + Grafana –º–µ—Ç—Ä–∏–∫–∏
- [ ] –ê–ª–µ—Ä—Ç—ã –≤ Telegram

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∫–æ–¥–∞

### –§–∞–∑–∞ 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ UX (1-2 –Ω–µ–¥–µ–ª–∏)
- [ ] –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∫—ç—à–∞ (Deep Dive –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É)
- [ ] Skeleton loaders
- [ ] Optimistic UI updates
- [ ] PWA manifest
- [ ] Offline mode

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë—ã—Å—Ç—Ä–æ–µ –∏ –ø—Ä–∏—è—Ç–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

### –§–∞–∑–∞ 4: –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (1 –Ω–µ–¥–µ–ª—è)
- [ ] Mixpanel –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- [ ] API documentation (Swagger)
- [ ] Runbook –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π
- [ ] Onboarding guide –¥–ª—è –Ω–æ–≤—ã—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ò–∑–º–µ—Ä—è–µ–º–æ–µ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

---

## üéØ –ë–´–°–¢–†–´–ï WINS (–º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –∑–∞ –¥–µ–Ω—å)

1. **OWNER_ID –≤ env** (10 –º–∏–Ω)
2. **Automated backups –≤ Railway** (30 –º–∏–Ω)
3. **–ò–Ω–¥–µ–∫—Å—ã –ë–î** (1 —á–∞—Å)
4. **Skeleton loaders** (3 —á–∞—Å–∞)
5. **Optimistic UI** (2 —á–∞—Å–∞)

**–ò—Ç–æ–≥–æ:** ~7 —á–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã ‚Üí –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ

---

## üí∞ –≠–ö–û–ù–û–ú–ò–Ø –°–†–ï–î–°–¢–í

### –ë–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π
- 1000 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞—Ö–æ–¥—è—Ç –≤ –¥–µ–Ω—å
- –ö–∞–∂–¥—ã–π –ø–æ–ª—É—á–∞–µ—Ç Daily Horoscope ‚Üí 1000 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ OpenAI
- 1 –∑–∞–ø—Ä–æ—Å ‚âà 1000 —Ç–æ–∫–µ–Ω–æ–≤ ‚âà $0.01
- **–ò—Ç–æ–≥–æ: $10/–¥–µ–Ω—å = $300/–º–µ—Å—è—Ü**

### –° –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º–∏
- –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à –ø–æ –∑–Ω–∞–∫–∞–º –∑–æ–¥–∏–∞–∫–∞ ‚Üí 12 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –¥–µ–Ω—å
- **–ò—Ç–æ–≥–æ: $0.12/–¥–µ–Ω—å = $3.60/–º–µ—Å—è—Ü**

**–≠–∫–æ–Ω–æ–º–∏—è: $296.40/–º–µ—Å—è—Ü (98.8%)**

---

## üìù CHECKLIST –ü–ï–†–ï–î PRODUCTION

- [ ] –í—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
- [ ] –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] Backup –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [ ] Monitoring —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Sentry –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] Rate limiting –≤–∫–ª—é—á–µ–Ω
- [ ] API keys –≤ secrets
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [ ] Runbook —Å–æ–∑–¥–∞–Ω

---

**–£—Å–ø–µ—Ö–æ–≤ –≤ —É–ª—É—á—à–µ–Ω–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è! üöÄ**
