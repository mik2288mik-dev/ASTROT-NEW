# 📊 КРАТКАЯ АРХИТЕКТУРА ПРИЛОЖЕНИЯ

## 🎯 Что это за приложение?

**Astrot** - астрологическое приложение в Telegram WebApp для расчета натальных карт, гороскопов и синастрии с использованием Swiss Ephemeris и AI (GPT-4).

---

## 🏗️ Как все устроено?

```
┌──────────────────────────────────────────────────────────────┐
│                     TELEGRAM WEBAPP                          │
│  (Пользователь открывает бота в Telegram)                    │
└────────────────────────────┬─────────────────────────────────┘
                             │
┌────────────────────────────▼─────────────────────────────────┐
│                      NEXT.JS APP                             │
│                                                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │   FRONTEND   │  │   BACKEND    │  │   DATABASE   │       │
│  │   (React)    │◄─┤  (API Routes)│◄─┤ (PostgreSQL) │       │
│  └──────────────┘  └──────┬───────┘  └──────────────┘       │
│                            │                                  │
│                    ┌───────▼────────┐                         │
│                    │   EXTERNAL     │                         │
│                    │   SERVICES     │                         │
│                    │ • Swiss Eph    │                         │
│                    │ • OpenAI       │                         │
│                    │ • WeatherAPI   │                         │
│                    └────────────────┘                         │
└──────────────────────────────────────────────────────────────┘
```

---

## 📦 Что откуда берется?

### 1. Данные пользователя

```
┌─────────────────┐
│ Пользователь    │
│ вводит данные   │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  Onboarding Form                    │
│  • Имя                              │
│  • Дата рождения (YYYY-MM-DD)       │
│  • Время рождения (HH:MM)           │
│  • Место рождения (город, страна)   │
│  • Язык (ru/en)                     │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  Сохранение в PostgreSQL            │
│  Таблица: users                     │
│  • id (Telegram user ID)            │
│  • name, birth_date, birth_time...  │
│  • is_setup = true                  │
└─────────────────────────────────────┘
```

### 2. Натальная карта

```
Данные пользователя
         │
         ▼
┌─────────────────────────────────────┐
│  API: /api/astrology/natal-chart    │
│                                     │
│  1. Геокодинг места рождения        │
│     (OpenStreetMap Nominatim)       │
│     "Moscow, Russia" → 55.7558° N   │
│                                     │
│  2. Определение часового пояса      │
│     (tz-lookup library)             │
│     Moscow → Europe/Moscow (UTC+3)  │
│                                     │
│  3. Конвертация времени в UTC       │
│     15:30 МСК → 12:30 UTC           │
│                                     │
│  4. Расчет Julian Day               │
│     (для Swiss Ephemeris)           │
│                                     │
│  5. Расчет позиций планет           │
│     Swiss Ephemeris Native Module   │
│     • Sun (Солнце)                  │
│     • Moon (Луна)                   │
│     • Ascendant (Асцендент)         │
│     • Mercury, Venus, Mars          │
│                                     │
│  6. Определение элемента            │
│     Fire/Water/Air/Earth            │
│                                     │
│  7. Управляющая планета             │
│     По знаку Солнца                 │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  Сохранение в PostgreSQL            │
│  Таблица: charts                    │
│  • user_id                          │
│  • chart_data (JSONB)               │
│  └─→ Кэшируется НАВСЕГДА            │
│      (не пересчитывается)           │
└─────────────────────────────────────┘
```

### 3. AI контент (Три ключа, гороскопы, Deep Dive)

```
Натальная карта готова
         │
         ▼
┌─────────────────────────────────────┐
│  generateAllContent()               │
│  (services/contentGenerationService)│
│                                     │
│  Генерирует ВСЁ сразу:              │
│  ┌───────────────────────────────┐  │
│  │ 1. Three Keys                 │  │
│  │    (GPT-4 запрос)             │  │
│  │    • Энергия                  │  │
│  │    • Любовь                   │  │
│  │    • Карьера                  │  │
│  └───────────────────────────────┘  │
│                                     │
│  ┌───────────────────────────────┐  │
│  │ 2. Daily Horoscope            │  │
│  │    (GPT-4 запрос)             │  │
│  │    • Настроение дня           │  │
│  │    • Совет                    │  │
│  │    • Цвет/число               │  │
│  └───────────────────────────────┘  │
│                                     │
│  ┌───────────────────────────────┐  │
│  │ 3. Deep Dive (5 секций)       │  │
│  │    (5x GPT-4 запросов)        │  │
│  │    • Личность                 │  │
│  │    • Любовь                   │  │
│  │    • Карьера                  │  │
│  │    • Слабости                 │  │
│  │    • Карма                    │  │
│  └───────────────────────────────┘  │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  Сохранение в PostgreSQL            │
│  Таблица: users                     │
│  Поле: generated_content (JSONB)    │
│  {                                  │
│    threeKeys: {...},                │
│    dailyHoroscope: {...},           │
│    deepDiveAnalyses: {              │
│      personality: "...",            │
│      love: "...",                   │
│      career: "...",                 │
│      weakness: "...",               │
│      karma: "..."                   │
│    },                               │
│    synastries: {},                  │
│    timestamps: {...}                │
│  }                                  │
└─────────────────────────────────────┘
```

---

## 🔄 Как работает при ПОВТОРНОМ входе?

```
Пользователь открывает приложение
         │
         ▼
┌─────────────────────────────────────┐
│  App.tsx → useEffect()              │
│  loadData()                         │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  API: GET /api/users/[id]           │
│  Загрузка профиля из БД             │
│  • Все данные пользователя          │
│  • generated_content (ВСЁ)          │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  API: GET /api/charts/[id]          │
│  Загрузка натальной карты из БД     │
│  • chart_data (JSONB)               │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  Проверка кэша                      │
│  • Есть threeKeys? ✓                │
│  • Есть dailyHoroscope? ✓           │
│  • Дата актуальна? ✓                │
│  • Есть deepDive? ✓                 │
│  └─→ Используем кэш                 │
│      (БЕЗ запросов к OpenAI!)       │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  Показываем Dashboard               │
│  • Все данные из кэша               │
│  • Быстрая загрузка                 │
│  • Экономия токенов                 │
└─────────────────────────────────────┘
```

**Итого:** При повторном входе - **0 запросов к OpenAI!**

---

## 🕐 Когда обновляется контент?

### Натальная карта и Three Keys
```
┌──────────────────────────┐
│   Генерируется ОДИН РАЗ  │
│   при первом входе       │
│   ────────────────────   │
│   НЕ обновляется         │
│   автоматически          │
│   ────────────────────   │
│   Обновление только      │
│   через платную          │
│   регенерацию            │
└──────────────────────────┘
```

### Daily Horoscope (ежедневный гороскоп)
```
┌──────────────────────────────────────────┐
│  Проверка при открытии Dashboard         │
│                                          │
│  IF dailyHoroscope.date === today        │
│  └─→ Использовать кэш (БЕЗ запроса)     │
│                                          │
│  IF dailyHoroscope.date < today          │
│  └─→ Загрузить новый                    │
│      1. Проверить глобальный кэш        │
│         (daily_horoscopes_cache)        │
│      2. Если есть для этого знака       │
│         → вернуть (БЕЗ запроса к AI)    │
│      3. Если нет                        │
│         → сгенерировать (1x OpenAI)     │
│         → сохранить в глобальный кэш    │
│                                          │
│  Обновляется: каждый день в 00:01 МСК   │
└──────────────────────────────────────────┘
```

**Оптимизация:** Гороскоп генерируется ОДИН раз в день для каждого знака зодиака, а затем используется всеми пользователями этого знака.

**Пример:**
- 1000 Овнов открывают приложение
- Первый Овен → генерация (1 запрос к OpenAI)
- Остальные 999 Овнов → из кэша (0 запросов)
- **Экономия: 999 запросов (99.9%)**

### Weekly/Monthly Horoscopes
```
┌──────────────────────────┐
│   Генерируются ОДИН РАЗ  │
│   при первом входе       │
│   ────────────────────   │
│   Обновляются раз в      │
│   неделю/месяц по        │
│   расписанию             │
└──────────────────────────┘
```

### Deep Dive анализы
```
┌──────────────────────────┐
│   Генерируются ОДИН РАЗ  │
│   при первом входе       │
│   (все 5 секций сразу)   │
│   ────────────────────   │
│   НЕ обновляются         │
│   автоматически          │
└──────────────────────────┘
```

---

## 💾 Где хранятся данные?

```
PostgreSQL Database (Railway)
│
├─ users                          [Профили пользователей]
│  ├─ id (Telegram ID)
│  ├─ name, birth_date, birth_time, birth_place
│  ├─ language, theme, is_premium, is_admin
│  └─ generated_content (JSONB)  ← ВЕСЬ AI контент
│     ├─ threeKeys
│     ├─ dailyHoroscope
│     ├─ weeklyHoroscope
│     ├─ monthlyHoroscope
│     ├─ deepDiveAnalyses
│     │  ├─ personality
│     │  ├─ love
│     │  ├─ career
│     │  ├─ weakness
│     │  └─ karma
│     ├─ synastries
│     └─ timestamps
│
├─ charts                         [Натальные карты]
│  ├─ user_id
│  └─ chart_data (JSONB)
│     ├─ sun, moon, rising
│     ├─ mercury, venus, mars
│     ├─ element, rulingPlanet
│     └─ summary
│
├─ daily_horoscopes_cache        [Глобальный кэш гороскопов]
│  ├─ zodiac_sign ("Aries", ...)
│  ├─ date (2025-12-18)
│  └─ horoscope_data (JSONB)
│
├─ synastry_cache                [Кэш синастрий]
│  ├─ user_id
│  ├─ partner_data (для ключа)
│  ├─ brief_analysis (краткая)
│  └─ full_analysis (полная)
│
└─ regenerations                 [Отслеживание регенераций]
   ├─ user_id
   ├─ content_type
   ├─ regeneration_date
   └─ was_paid, stars_cost
```

---

## 🚀 Что происходит при первом входе?

### Шаг за шагом:

```
1. Пользователь → Onboarding
   └─→ Ввод: Имя, дата/время/место рождения

2. Валидация данных
   └─→ Проверка формата, даты, места

3. Расчет натальной карты
   └─→ API /api/astrology/natal-chart
       ├─ Геокодинг места
       ├─ Часовой пояс
       ├─ Конвертация в UTC
       └─ Swiss Ephemeris расчет
   └─→ Сохранение в charts table

4. Генерация AI контента
   └─→ generateAllContent()
       ├─ Three Keys (1x OpenAI)
       ├─ Daily Horoscope (1x OpenAI)
       └─ Deep Dive x5 (5x OpenAI)
   └─→ Сохранение в users.generated_content

5. Показ HookChat
   └─→ Анимированный показ Three Keys

6. Переход в Dashboard
   └─→ Все данные готовы и в кэше
```

**Время:** ~10-15 секунд  
**Запросов к OpenAI:** 7-8  
**Стоимость:** ~$0.05-0.10 (в зависимости от длины)

---

## 🔄 Что происходит при повторном входе?

### Шаг за шагом:

```
1. Пользователь открывает приложение
   └─→ App.tsx → useEffect()

2. Загрузка профиля
   └─→ API GET /api/users/[id]
       └─ Из PostgreSQL users table

3. Загрузка натальной карты
   └─→ API GET /api/charts/[id]
       └─ Из PostgreSQL charts table

4. Проверка кэша
   └─→ generated_content уже есть
       ├─ threeKeys ✓
       ├─ dailyHoroscope ✓ (если сегодняшний)
       ├─ deepDive ✓
       └─ Используем все из кэша

5. Показ Dashboard
   └─→ Все данные уже готовы
       └─ Мгновенная загрузка
```

**Время:** ~1-2 секунды  
**Запросов к OpenAI:** 0  
**Стоимость:** $0

---

## 💰 Как работает премиум?

```
┌────────────────────────────────────┐
│  Бесплатные функции:               │
│  ✓ Натальная карта (summary)      │
│  ✓ Three Keys                      │
│  ✓ Daily Horoscope                 │
│  ✓ Краткая синастрия               │
│  ✗ Deep Dive (превью)              │
│  ✗ Weekly/Monthly horoscope        │
│  ✗ Полная синастрия                │
│  ✗ Oracle (чат с AI)               │
└────────────────────────────────────┘
         │
         │ Покупка за 250 Telegram Stars
         ▼
┌────────────────────────────────────┐
│  Премиум функции:                  │
│  ✓ Все бесплатные                  │
│  ✓ Deep Dive (5 секций)            │
│  ✓ Weekly/Monthly horoscope        │
│  ✓ Полная синастрия                │
│  ✓ Oracle (чат с AI)               │
│  ✓ Регенерация контента            │
└────────────────────────────────────┘
```

### Оплата через Telegram Stars

```
1. Пользователь нажимает "Get Premium"
   └─→ Paywall view

2. Нажимает кнопку оплаты
   └─→ telegramService.requestStarsPayment()

3. Telegram показывает окно оплаты
   └─→ 250 Stars (Telegram внутренняя валюта)

4. После успешной оплаты
   └─→ Обновление profile.isPremium = true
   └─→ Сохранение в БД

5. Разблокировка премиум функций
   └─→ Доступ ко всем экранам
```

---

## 🎨 Как устроен интерфейс?

```
App.tsx (главный компонент)
│
├─ Header (шапка с навигацией)
│
└─ Views (экраны)
   │
   ├─ Onboarding         → Форма ввода данных
   ├─ HookChat           → Показ Three Keys
   ├─ Dashboard          → Главный хаб
   │  ├─ CosmicPassport     (Паспорт души)
   │  ├─ WeatherWidget      (Погода)
   │  ├─ ThreeKeysPreview   (3 ключа)
   │  ├─ SoulEvolution      (Эволюция)
   │  └─ NavigationMenu     (Меню)
   │
   ├─ NatalChart         → Натальная карта
   │  ├─ Summary            (Краткий портрет)
   │  └─ DeepDive           (Глубокий анализ)
   │     ├─ Personality
   │     ├─ Love
   │     ├─ Career
   │     ├─ Weakness
   │     └─ Karma
   │
   ├─ Horoscope          → Гороскопы
   │  ├─ Daily              (На сегодня)
   │  ├─ Weekly             (На неделю)
   │  └─ Monthly            (На месяц)
   │
   ├─ Synastry           → Совместимость
   │  ├─ PartnerForm        (Ввод данных)
   │  ├─ BriefMode          (Краткая)
   │  └─ FullMode           (Полная - премиум)
   │
   ├─ OracleChat         → Чат с AI (премиум)
   │
   ├─ Settings           → Настройки
   │  ├─ Profile
   │  ├─ Language
   │  ├─ Theme
   │  ├─ WeatherCity
   │  └─ Subscription
   │
   ├─ Paywall            → Экран покупки
   │
   └─ AdminPanel         → Админка (для владельца)
```

---

## 🔧 Как добавить новую функцию?

### Пример: Добавление транзитов

#### 1. Создать API endpoint
```typescript
// pages/api/astrology/transits.ts
export default async function handler(req, res) {
  const { profile, chartData, date } = req.body;
  
  // Расчет транзитов через Swiss Ephemeris
  const transits = await calculateTransits(chartData, date);
  
  // Генерация интерпретации через OpenAI
  const analysis = await generateTransitAnalysis(transits, profile);
  
  res.json({ transits, analysis });
}
```

#### 2. Добавить функцию в сервис
```typescript
// services/astrologyService.ts
export const getTransits = async (profile, chartData, date) => {
  const response = await fetch('/api/astrology/transits', {
    method: 'POST',
    body: JSON.stringify({ profile, chartData, date })
  });
  return response.json();
};
```

#### 3. Добавить в кэш
```typescript
// types.ts
export interface UserGeneratedContent {
  // ...existing
  transits?: {
    date: string;
    analysis: string;
    planets: TransitPlanet[];
  };
}
```

#### 4. Создать UI компонент
```typescript
// views/Transits.tsx
export const Transits: React.FC<Props> = ({ profile, chartData }) => {
  const [transits, setTransits] = useState(null);
  
  useEffect(() => {
    // Проверить кэш
    if (profile.generatedContent?.transits) {
      setTransits(profile.generatedContent.transits);
    } else {
      // Загрузить
      getTransits(profile, chartData, new Date()).then(setTransits);
    }
  }, []);
  
  return <div>...</div>;
};
```

#### 5. Добавить в навигацию
```typescript
// App.tsx
type ViewState = '...' | 'transits';

// В render
{view === 'transits' && <Transits />}
```

---

## 📊 Статистика использования API

### Первый вход пользователя

| Сервис | Запросов | Назначение |
|--------|----------|------------|
| OpenStreetMap | 1 | Геокодинг места рождения |
| Swiss Ephemeris | 6 | Расчет планет + Асцендент |
| OpenAI GPT-4 | 7 | Three Keys + Daily + Deep Dive x5 |
| PostgreSQL | 2 | Сохранение профиля + карты |
| **ИТОГО** | **16** | |

### Повторный вход

| Сервис | Запросов | Назначение |
|--------|----------|------------|
| PostgreSQL | 2 | Загрузка профиля + карты |
| **ИТОГО** | **2** | |

### Обновление daily horoscope

| Сервис | Запросов | Назначение |
|--------|----------|------------|
| PostgreSQL | 1 | Проверка кэша |
| OpenAI GPT-4 | 0-1 | Только если нет в кэше |
| **ИТОГО** | **1-2** | |

---

## 🎯 Ключевые метрики

- **Время первой загрузки:** 10-15 секунд
- **Время повторной загрузки:** 1-2 секунды
- **Экономия на кэше гороскопов:** 99.9%
- **Стоимость первого входа:** $0.05-0.10
- **Стоимость повторного входа:** $0
- **Размер БД на 1000 пользователей:** ~50-100 MB

---

## 🔒 Что нужно знать администратору

### Переменные окружения (критичные)
```bash
DATABASE_URL=postgresql://...    # ✅ Есть
OPENAI_API_KEY=sk-...           # ✅ Есть
WEATHER_API=...                 # ⚠️ Опционально
```

### Проверка здоровья
```bash
curl https://your-app.railway.app/api/health
```

### Запуск миграций
```bash
curl -X POST https://your-app.railway.app/api/migrations/run
```

### Просмотр логов
```bash
railway logs
```

### Backup базы данных
```bash
railway run pg_dump $DATABASE_URL > backup.sql
```

---

## ⚠️ Важные ограничения

1. **Swiss Ephemeris:** Данные только с 1900 по 2100 год
2. **OpenAI:** Rate limit 3500 запросов/минуту (Tier 2)
3. **PostgreSQL:** 512 MB RAM, 1 GB storage (Railway free tier)
4. **Telegram Stars:** Минимум 1 звезда, максимум 2500 звезд за транзакцию

---

## 🚨 Что делать при проблемах?

### База данных не подключается
```bash
# Проверить DATABASE_URL
echo $DATABASE_URL

# Проверить доступность
psql $DATABASE_URL -c "SELECT 1"

# Запустить миграции
curl -X POST /api/migrations/run
```

### OpenAI возвращает ошибки
```bash
# Проверить ключ
echo $OPENAI_API_KEY

# Проверить лимиты
curl https://api.openai.com/v1/usage \
  -H "Authorization: Bearer $OPENAI_API_KEY"
```

### Swiss Ephemeris не работает
```bash
# Проверить файлы эфемерид
ls -la ephe/

# Проверить EPHE_PATH
echo $EPHE_PATH

# Пересобрать
npm run build
```

---

**Конец краткой архитектуры**

*Для подробной информации см. `FULL_APPLICATION_AUDIT.md`*
